<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your Progress - TheraFit</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/style.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="app-container">

        <!-- Navbar -->
        <nav class="navbar-custom">
            <div class="navbar-container">
                <a href="index.html" class="navbar-brand">
                    <img src="images/logo.png" class="brand-icon">
                </a>
                <div class="navbar-links">
                    <a href="index.html" class="nav-link">Exercises</a>
                    <a href="progress.html" class="nav-link active">Progress</a>
                    <a href="about.html" class="nav-link">About</a>
                </div>
            </div>
        </nav>

        <main class="main-content">

            <header class="page-header">
                <h1 class="page-title">Your Progress</h1>
                <p class="page-subtitle">Track your exercise journey</p>
            </header>

            <div class="row g-3 progress-summary">
                <div class="col-md-6">
                    <div class="progress-card">
                        <span class="fs-1 text-primary">üèÜ</span>
                        <div>
                            <div class="progress-number" id="stat-total">0</div>
                            <div class="text-muted">Total Completions</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="progress-card">
                        <span class="fs-1 text-primary">üìÖ</span>
                        <div>
                            <div class="progress-number" id="stat-unique">0</div>
                            <div class="text-muted">Unique Exercises</div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- ================= TO DO CARD ================= -->
            <section class="mt-4">
                <div class="card mx-auto" style="max-width:1100px">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Exercise To-Do</h5>

                        <div id="todo-list" class="row g-3">
                            <p class="text-muted">No exercises selected.</p>
                        </div>

                        <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#exerciseModal">
                            Add Exercises
                        </button>
                    </div>
                </div>
            </section>

            <!-- ================= MODAL ================= -->
            <div class="modal fade" id="exerciseModal" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title">Select Exercises</h5>
                            <button class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body">
                            <div id="exercise-modal-list" class="row g-2"></div>
                        </div>

                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button id="save-exercises" class="btn btn-primary">Save</button>
                        </div>

                    </div>
                </div>
            </div>

            <!-- ================= CLEAR CONFIRM MODAL ================= -->
            <div class="modal fade" id="clearProgressModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header border-0 pb-0">
                            <h5 class="modal-title fw-bold text-danger">Clear All Progress?</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-muted mb-0">
                                Are you sure you want to delete all progress and selected exercises?
                                <br><strong>This action cannot be undone.</strong>
                            </p>
                        </div>
                        <div class="modal-footer border-0 pt-0">
                            <button type="button" class="btn btn-secondary rounded-pill px-4"
                                data-bs-dismiss="modal">Cancel</button>
                            <button type="button" id="confirm-clear" class="btn btn-danger rounded-pill px-4">Yes, Clear
                                Everything</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= COMPLETED HISTORY ================= -->
            <section class="mt-5">
                <h4 class="mb-3">Completed Exercises</h4>
                <ul id="history-list" class="list-group"></ul>
                <p id="empty-history" class="text-muted mt-3 d-none">No completed exercises yet.</p>
            </section>
            <br><br>
            <div class="d-flex gap-2 justify-content-center no-print">
                <button onclick="window.print()" class="btn btn-outline-primary">
                    üñ® Print Progress
                </button>
                <button id="btn-clear" class="btn btn-outline-danger" data-bs-toggle="modal"
                    data-bs-target="#clearProgressModal">
                    üóë Clear Progress
                </button>
            </div>
        </main>
    </div>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Shared Data -->
    <script src="assets/js/exercises.js"></script>
    <script src="assets/js/progress.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            /* ================= FETCH PROGRESS DATA ================= */
            const completed = ProgressManager.getCompleted();

            /* ================= UPDATE STATS ================= */
            const totalCompletions = completed.length;

            const uniqueExercises = new Set(
                completed.map(ex => ex.id)
            ).size;

            document.getElementById('stat-total').textContent = totalCompletions;
            document.getElementById('stat-unique').textContent = uniqueExercises;

            /* ================= EXISTING LOGIC ================= */
            const completedIds = completed.map(e => e.id);
            let selected = JSON.parse(localStorage.getItem('selected-plan')) || [];

            const modalList = document.getElementById('exercise-modal-list');
            const todoList = document.getElementById('todo-list');
            const historyList = document.getElementById('history-list');
            const emptyHistory = document.getElementById('empty-history');

            /* ================= MODAL EXERCISES ================= */
            modalList.innerHTML = '';
            exercises.forEach(ex => {
                const col = document.createElement('div');
                col.className = 'col-md-6';

                const isSelected = selected.some(s => s.id === ex.id);
                const isDone = completedIds.includes(ex.id);

                col.innerHTML = `
      <div class="border rounded p-2 d-flex justify-content-between align-items-center">
        <div>
          <strong>${ex.name}</strong><br>
          <small class="text-muted">${ex.categoryLabel}</small>
        </div>
        <input type="checkbox"
               value="${ex.id}"
               ${isSelected || isDone ? 'checked' : ''}
               ${isDone ? 'disabled' : ''}>
      </div>
    `;
                modalList.appendChild(col);
            });

            /* ================= SAVE SELECTION ================= */
            document.getElementById('save-exercises').onclick = () => {
                selected = [];
                modalList.querySelectorAll('input').forEach(cb => {
                    if (cb.checked) {
                        const ex = exercises.find(e => e.id == cb.value);
                        selected.push(ex);
                    }
                });
                localStorage.setItem('selected-plan', JSON.stringify(selected));
                renderTodo();
                bootstrap.Modal.getInstance(
                    document.getElementById('exerciseModal')
                ).hide();
            };

            /* ================= TODO LIST ================= */
            function renderTodo() {
                todoList.innerHTML = '';

                if (selected.length === 0) {
                    todoList.innerHTML = `<p class="text-muted">No exercises selected.</p>`;
                    return;
                }

                selected.forEach(ex => {
                    const done = completedIds.includes(ex.id);

                    const col = document.createElement('div');
                    col.className = 'col-md-6';

                    col.innerHTML = `
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <strong>${ex.name}</strong>
              <input type="checkbox" ${done ? 'checked disabled' : ''}>
            </div>

            <div class="progress mt-2">
              <div class="progress-bar ${done ? 'bg-success' : 'bg-secondary'}"
                   style="width:${done ? 100 : 0}%"></div>
            </div>

            <small class="text-muted">
              Status: ${done ? 'Completed' : 'Pending'}
            </small>
          </div>
        </div>
      `;
                    todoList.appendChild(col);
                });
            }

            renderTodo();

            /* ================= COMPLETED HISTORY ================= */
            if (completed.length === 0) {
                emptyHistory.classList.remove('d-none');
            } else {
                completed.slice().reverse().forEach((ex, i) => {
                    const id = `collapse-${ex.id}-${i}`;

                    // üîπ Fetch duration from index (exercises.js)
                    const baseExercise = exercises.find(e => e.id === ex.id);
                    const duration = baseExercise?.duration || 'N/A';

                    const li = document.createElement('li');
                    li.className = 'list-group-item';

                    li.innerHTML = `
      <a data-bs-toggle="collapse"
         href="#${id}"
         class="fw-semibold text-decoration-none">
        ${ex.name}
      </a>

      <div class="collapse mt-2" id="${id}">
        <div class="card card-body p-2">
          <div><strong>Duration:</strong> ${duration} seconds</div>
          <div><strong>Notes:</strong> ${ex.notes || 'Well done!'}</div>
        </div>
      </div>
    `;

                    historyList.appendChild(li);
                });
            }

            /* ================= CLEAR BUTTON LOGIC (MODAL) ================= */
            document.getElementById('confirm-clear').addEventListener('click', () => {
                localStorage.removeItem('exercise-planner-progress');
                localStorage.removeItem('selected-plan');
                location.reload();
            });


        });
    </script>


</body>

</html>